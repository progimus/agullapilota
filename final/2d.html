<html>
    <head>
        <meta charset="utf-8">
        <title>Fliper</title>
        <script src="../libs/planck.js"></script>
        <script src="../libs/planck-with-testbed.js"></script>
        <script src="models/flipper.json"></script>

        <script type="text/javascript" src="../supreme.json"></script>

        <style>
            body {
                margin: 0px auto;
            }
        </style>
    </head>
    <body>
        <script>

            const pl = planck, Vec2 = pl.Vec2;

            planck.testbed("Pinball", function(testbed) {
                var pl = planck, Vec2 = pl.Vec2;
                var world = new pl.World(Vec2(0, -30));

                var flipperLeft = new Flipper(world, {
                    position: [-7.92, -37.07, 1],
            		angle: 0,
            		mass: 50,
            		points: flipperJSON.find(e => e.name == 'flipperLeft').points,
            		lines: flipperJSON.find(e => e.name == 'flipperLeft').lines,
            		activeKey: 37,
            		active: false,
            		velocity: { down: -30, up: 30 },
            		limits: { lower: -0.52, upper: 0.52 },
                    orientation: 'right'
                })

                var flipperRight = new Flipper(world, {
            		position: [7.92, -37.07, 1],
            		angle: 0,
            		mass: 50,
            		points: flipperJSON.find(e => e.name == 'flipperRight').points,
            		lines: flipperJSON.find(e => e.name == 'flipperRight').lines,
            		activeKey: 39,
            		active: false,
            		velocity: { down: 30, up: -30 },
            		limits: { lower: 0.52, upper: -0.52 },
                    orientation: 'left'
                })

                testbed.step = function(settings) {
                    flipperLeft.update();
                    flipperRight.update();
                };

                return world;
            });

            function Flipper(world, def) {
                this.body = world.createDynamicBody({
            		position: Vec2(def.position[0], def.position[1]),
            		bullet: true
            	});

            	this.body.createFixture(pl.Circle(1), def.mass);
            	this.createFixture(this.body, def);

                this.orientation = def.orientation;
            	this.velocity = { down: def.velocity.down, up: def.velocity.up };
            	this.limits = { lower: def.limits.lower, upper: def.limits.upper };

            	let optionJoint = {
                    enableMotor: true,
                    lowerAngle: this.limits.lower,
                    upperAngle: this.limits.upper,
                    enableLimit: true,
                    collideConnected: false,
                    maxMotorTorque: 150000
                };

                this.motor = world.createJoint(pl.RevoluteJoint(optionJoint, world.createBody(), this.body, Vec2(def.position[0], def.position[1])));

                document.body.addEventListener('keydown', evt => {
                	if(evt.keyCode == def.activeKey) this.active = true;
                });

                document.body.addEventListener('keyup', evt => {
                	if(evt.keyCode == def.activeKey) this.active = false;
                });
            }

            Flipper.prototype.update = function() {
                    this.body.setFixedRotation(false);

                    if(this.orientation == 'left') {
                    	if(this.active) {
                            if(this.motor.getJointAngle() >= this.limits.upper) {
                                this.body.setAngle(this.limits.upper);
                                this.body.setFixedRotation(true);
                            }
                        } else {
                            if(this.motor.getJointAngle() <= this.limits.lower) {
                                this.body.setAngle(this.limits.lower);
                                this.body.setFixedRotation(true);
                            }
                        }
                    } else {
                    	if(this.active) {
                            if(this.motor.getJointAngle() <= this.limits.upper) {
                                this.body.setAngle(this.limits.upper);
                                this.body.setFixedRotation(true);
                            }
                        } else {
                            if(this.motor.getJointAngle() >= this.limits.lower) {
                                this.body.setAngle(this.limits.lower);
                                this.body.setFixedRotation(true);
                            }
                        }
                    }

                    this.motor.setMotorSpeed(this.active ? this.velocity.up : this.velocity.down);
            }

            Flipper.prototype.createFixture = function(body, def) {
            	var points = def.points,
            		lines = def.lines;

            	for(var i = 0; i < lines.length; i += 2) {
                    var index1 = lines[i] * 3,
                    	index2 = lines[i + 1] * 3;

                    var x1 = points[index1],
                    	y1 = points[index1 + 2],
                    	x2 = points[index2],
                    	y2 = points[index2 + 2];

                    body.createFixture(pl.Edge(Vec2(x1, y1), Vec2(x2, y2)), 0);
                }
            }
        </script>
    </body>
</html>
